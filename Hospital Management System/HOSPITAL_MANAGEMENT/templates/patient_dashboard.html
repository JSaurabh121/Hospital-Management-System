{% extends "base.html" %}
{% block title %}Dashboard - MaxCare{% endblock %}

{% block content %}
<div class="container">

  <!-- WELCOME SECTION -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
      <h1 style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--text-main);">Welcome, <span
          class="text-primary">{{ patient.username }}</span></h1>
      <p class="text-muted">manage your health and appointments</p>
    </div>
    <div>
      <a href="{{ url_for('edit_profile') }}" class="btn btn-outline btn-sm">
        <i class="fas fa-user-edit"></i> Edit Profile
      </a>
      <a href="{{ url_for('my_history') }}" class="btn btn-primary btn-sm">
        <i class="fas fa-history"></i> Medical History
      </a>
    </div>
  </div>

  <!-- MAIN GRID -->
  <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">

    <!-- LEFT COLUMN: APPOINTMENTS -->
    <div>
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h3>Upcoming Appointments</h3>
          <span class="text-muted" style="font-size: 0.9rem;">{{ upcoming_appointments|length }} scheduled</span>
        </div>

        {% if upcoming_appointments %}
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          {% for appt in upcoming_appointments %}
          {% set doc = appt.doctor_user %}
          {% set prof = doc.doctor_profile if doc else None %}
          {% set dept = prof.department if prof else None %}

          <div
            style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #eee; border-radius: var(--radius-md); transition: var(--transition);">
            <div style="display: flex; gap: 1rem; align-items: center;">
              <div
                style="width: 50px; height: 50px; background: #EEF2FF; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 1.2rem;">
                <i class="fas fa-user-md"></i>
              </div>
              <div>
                <h4 style="font-size: 1rem; margin: 0;">Dr. {{ doc.username }}</h4>
                <p class="text-muted" style="font-size: 0.85rem;">{{ dept.Department_name if dept else 'General' }}</p>
                <p style="font-size: 0.85rem; color: var(--text-main); font-weight: 500;">
                  <i class="far fa-calendar-alt"></i> {{ appt.date }} &nbsp;
                  <i class="far fa-clock"></i> {{ appt.time }}
                </p>
              </div>
            </div>
            <a href="{{ url_for('cancel_appointment', appt_id=appt.id) }}" class="btn btn-danger btn-sm"
              onclick="return confirm('Are you sure?')">Cancel</a>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
          <i class="far fa-calendar-check" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
          <p>No upcoming appointments.</p>
        </div>
        {% endif %}
      </div>

      <!-- CANCELLED APPOINTMENTS (Collapsible or just listed below) -->
      {% if cancelled_appointments %}
      <div class="card" style="opacity: 0.8;">
        <h3>Cancelled History</h3>
        <div style="margin-top: 1rem;">
          {% for appt in cancelled_appointments %}
          {% set doc = appt.doctor_user %}
          <div
            style="padding: 0.75rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-muted);">
            <span>Dr. {{ doc.username }} ({{ appt.date }})</span>
            <span style="color: var(--danger);">Cancelled</span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- RIGHT COLUMN: DEPARTMENTS / BOOKING -->
    <div>
      <div class="card"
        style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
        <h3>Book Appointment</h3>
        <p style="opacity: 0.9; margin-bottom: 1.5rem;">Select a department to find a specialist.</p>

        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
          {% for dept in departments %}
          <a href="{{ url_for('department_details', dept_id=dept.id) }}"
            style="background: rgba(255,255,255,0.2); padding: 10px 15px; border-radius: var(--radius-md); color: white; display: flex; justify-content: space-between; align-items: center; text-decoration: none; transition: 0.2s;">
            <span>{{ dept.Department_name }}</span>
            <i class="fas fa-chevron-right" style="font-size: 0.8rem;"></i>
          </a>
          {% endfor %}
        </div>
      </div>

      <div class="card">
        <h3>Quick Tips</h3>
        <ul
          style="list-style: disc; margin-left: 1.5rem; color: var(--text-muted); font-size: 0.9rem; line-height: 1.8;">
          <li>Arrive 15 mins before your slot.</li>
          <li>Carry your previous prescriptions.</li>
          <li>Wear a mask if required.</li>
        </ul>
      </div>
    </div>

  </div>
</div>
{% endblock %}